@implements IDisposable
@inject ChoresState State

<section class="feature-page">
    <header>
        <h1>Chores</h1>
    </header>

    <ChoreComposer OnSubmit="HandleAddAsync" />

    @if (State.IsLoading)
    {
        <p class="status-message status-message--loading" role="status" aria-live="polite">Loading chores...</p>
    }
    else if (!string.IsNullOrWhiteSpace(State.Error))
    {
        <p class="status-message status-message--error" role="alert">@State.Error</p>
    }
    else
    {
        <ChoreList Items="State.Items" OnToggleComplete="HandleToggleCompleteAsync" />
    }
</section>

@code {
    protected override async Task OnInitializedAsync()
    {
        State.Changed += HandleStateChanged;
        await State.RefreshAsync();
    }

    private async Task HandleAddAsync(CreateChoreRequest request)
    {
        await State.AddAsync(request);
    }

    private async Task HandleToggleCompleteAsync(Guid id)
    {
        await State.ToggleCompleteAsync(id);
    }

    private void HandleStateChanged()
    {
        _ = InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        State.Changed -= HandleStateChanged;
    }
}
