@implements IDisposable
@inject ExpensesState State

<section class="feature-page">
    <header>
        <h1>Expenses</h1>
    </header>

    <ExpenseComposer OnSubmit="HandleAddAsync" />

    @if (State.IsLoading)
    {
        <p class="status-message status-message--loading" role="status" aria-live="polite">Loading expenses...</p>
    }
    else if (!string.IsNullOrWhiteSpace(State.Error))
    {
        <p class="status-message status-message--error" role="alert">@State.Error</p>
    }
    else
    {
        <ExpenseList Items="State.Items" OnToggleSettled="HandleToggleSettledAsync" />
    }
</section>

@code {
    protected override async Task OnInitializedAsync()
    {
        State.Changed += HandleStateChanged;
        await State.RefreshAsync();
    }

    private async Task HandleAddAsync(CreateExpenseRequest request)
    {
        await State.AddAsync(request);
    }

    private async Task HandleToggleSettledAsync(Guid id)
    {
        await State.ToggleSettledAsync(id);
    }

    private void HandleStateChanged()
    {
        _ = InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        State.Changed -= HandleStateChanged;
    }
}
